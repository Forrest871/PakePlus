<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>歌词播放器 - Visual4u4</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #111;
      color: #ccc;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: sans-serif;
    }

    #lyrics-container {
      width: 1440px;
      height: 720px;
      overflow: hidden;
      background: #000;
      border: 1px solid #444;
      position: relative;
      margin-top: 20px;
    }

    #lyrics {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.3s ease-out;
      font-size: 61px;
      font-family: inherit;
      letter-spacing: 1px;
    }

    #lyrics div {
      line-height: 2;
      font-size: 1em;
      padding: 5px 10px;
      cursor: pointer;
      white-space: pre-wrap;
      letter-spacing: inherit;
    }

    .current {
      color: #ffffff;
      font-size: 1.3em !important;
      font-weight: bold;
    }

    #controls {
      color: #fff;
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
    }

    button:hover {
      background: #444;
    }

    input[type="number"] {
      width: 70px;
      padding: 5px;
      font-size: 16px;
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }

    #fontFamilySelect {
      padding: 5px;
      font-size: 16px;
      min-width: 200px;
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }
  </style>
</head>
<body>
  <div id="controls">
    <div class="control-group">
      <label>📝 字幕文件：</label>
      <input type="file" id="subFile" accept=".lrc,.srt">
    </div>
    
    <div class="control-group">
      <button id="play">▶️ 播放</button>
      <button id="pause">⏸️ 暂停</button>
      <button id="stop">⏹️ 停止</button>
    </div>

    <div class="control-group">
      <label>字体：</label>
      <select id="fontFamilySelect">
        <option value="Arial">Arial (英文)</option>
        <option value="Microsoft YaHei" selected>微软雅黑</option>
        <option value="SimSun">宋体</option>
        <option value="SimHei">黑体</option>
        <option value="更纱黑体 SC">开源斜黑</option>
        <option value="更纱黑体 SC">开源黑体</option>
        <option value="FangSong">仿宋</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Courier New">Courier New</option>
        <option value="Georgia">Georgia</option>
        <option value="Helvetica">Helvetica</option>
        <option value="custom">自定义字体...</option>
      </select>
    </div>

    <div class="control-group">
      <label>字号：</label>
      <input type="number" id="fontSizeInput" value="61" min="20" max="100">
      <span>px</span>
    </div>

    <div class="control-group">
      <label>字间距：</label>
      <input type="number" id="letterSpacingInput" value="1" min="0" max="10" step="0.1">
      <span>px</span>
    </div>
  </div>

  <div id="lyrics-container">
    <div id="lyrics">请上传字幕文件 (LRC/SRT)</div>
  </div>

  <script>
    const lyricsEl = document.getElementById('lyrics');
    const fileInput = document.getElementById('subFile');
    const playBtn = document.getElementById('play');
    const pauseBtn = document.getElementById('pause');
    const stopBtn = document.getElementById('stop');
    const fontSizeInput = document.getElementById('fontSizeInput');
    const fontFamilySelect = document.getElementById('fontFamilySelect');
    const letterSpacingInput = document.getElementById('letterSpacingInput');
    
    let lyricsData = [];
    let timer = null;
    let startTime = null;
    let pausedTime = 0;
    let playing = false;

    // 字体选择功能
    fontFamilySelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        const fontName = prompt('请输入系统已安装的字体名称：');
        if (fontName) {
          document.body.style.fontFamily = `'${fontName}', sans-serif`;
        }
      } else {
        document.body.style.fontFamily = `'${this.value}', sans-serif`;
      }
    });

    // 字号调整
    fontSizeInput.addEventListener('input', () => {
      lyricsEl.style.fontSize = `${fontSizeInput.value}px`;
    });

    // 字间距调整
    letterSpacingInput.addEventListener('input', () => {
      lyricsEl.style.letterSpacing = `${letterSpacingInput.value}px`;
    });

    // 文件处理
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (evt) => {
        if (file.name.endsWith('.srt')) {
          parseSRT(evt.target.result);
        } else {
          parseLRC(evt.target.result);
        }
      };
      reader.onerror = () => alert('文件读取失败');
      reader.readAsText(file, 'utf-8');
    });

    function parseLRC(text) {
      lyricsData = [];
      const lines = text.split("\n");
      for (const line of lines) {
        const timeTags = [...line.matchAll(/\[(\d{2}):(\d{2})(?:\.(\d{1,3}))?\]/g)];
        const lyricText = line.replace(/\[.*?\]/g, '').trim();
        timeTags.forEach(tag => {
          const minutes = parseInt(tag[1]);
          const seconds = parseInt(tag[2]);
          const millis = parseInt(tag[3] || "0");
          lyricsData.push({ 
            time: minutes * 60 + seconds + millis / 1000,
            text: lyricText
          });
        });
      }
      processSubtitles();
    }

    function parseSRT(text) {
      lyricsData = [];
      const blocks = text.split(/\n\s*\n/);
      for (const block of blocks) {
        const lines = block.split('\n').filter(l => l.trim() !== '');
        if (lines.length < 3) continue;
        
        const timeMatch = lines[1].match(/(\d{1,2}):(\d{2}):(\d{2})[,.](\d{3})\s*-->\s*(\d{1,2}):(\d{2}):(\d{2})[,.](\d{3})/);
        if (!timeMatch) continue;
        
        const hours = parseInt(timeMatch[1]);
        const minutes = parseInt(timeMatch[2]);
        const seconds = parseInt(timeMatch[3]);
        const millis = parseInt(timeMatch[4]);
        const text = lines.slice(2).join('\n').trim();
        
        lyricsData.push({
          time: hours * 3600 + minutes * 60 + seconds + millis / 1000,
          text: text
        });
      }
      processSubtitles();
    }

    function processSubtitles() {
      lyricsData.sort((a, b) => a.time - b.time);
      lyricsEl.innerHTML = "";
      
      if (lyricsData.length === 0) {
        lyricsEl.innerHTML = "未解析出有效内容";
        return;
      }
      
      lyricsData.forEach(line => {
        const div = document.createElement('div');
        div.textContent = line.text;
        div.dataset.time = line.time;
        div.addEventListener('click', () => jumpTo(line.time));
        lyricsEl.appendChild(div);
      });
      
      resetLyrics();
    }

    function resetLyrics() {
      clearInterval(timer);
      playing = false;
      pausedTime = 0;
      lyricsEl.style.transform = `translateY(0)`;
      [...lyricsEl.children].forEach(el => el.classList.remove('current'));
    }

    function updateLyrics() {
      const elapsed = (Date.now() - startTime) / 1000 + pausedTime;
      let index = lyricsData.findIndex(line => line.time > elapsed);
      index = index === -1 ? lyricsData.length - 1 : Math.max(index - 1, 0);
      
      [...lyricsEl.children].forEach(el => el.classList.remove('current'));
      const current = lyricsEl.children[index];
      
      if (current) {
        current.classList.add('current');
        const offset = current.offsetTop + current.clientHeight / 2;
        lyricsEl.style.transform = `translateY(${lyricsEl.parentElement.clientHeight / 2 - offset}px)`;
      }
    }

    playBtn.addEventListener('click', () => {
      if (playing || !lyricsData.length) return;
      startTime = Date.now();
      timer = setInterval(updateLyrics, 100);
      playing = true;
    });

    pauseBtn.addEventListener('click', () => {
      if (!playing) return;
      clearInterval(timer);
      pausedTime += (Date.now() - startTime) / 1000;
      playing = false;
    });

    stopBtn.addEventListener('click', resetLyrics);

    function jumpTo(time) {
      pausedTime = time;
      startTime = Date.now();
      updateLyrics();
      if (playing) {
        clearInterval(timer);
        timer = setInterval(updateLyrics, 100);
      }
    }
  </script>
</body>
</html>